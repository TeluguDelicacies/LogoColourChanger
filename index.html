<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TD Logo Customizer — Complementary (HSL)</title>
<style>
  :root{
    --bg:#f4f6f8; --card:#fff; --muted:#6b7280; --accent:#0b74d1; --radius:12px;
    --control-bg:#FBFCFD;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#111;}
  .page{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box;}
  .card{
    width:min(1080px,96%); background:var(--card); border-radius:var(--radius); padding:20px;
    box-shadow:0 8px 30px rgba(16,24,40,0.08); display:flex; gap:24px; align-items:flex-start;
  }

  /* Left controls */
  .left{width:56%; display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  h1{margin:0 0 4px 0; font-size:20px;}
  .desc{margin:0 0 12px 0;color:var(--muted);font-size:13px;line-height:1.3}

  .panel{
    background:var(--control-bg); border-radius:10px; padding:12px; border:1px solid rgba(15,23,42,0.03);
    display:flex; flex-direction:column; gap:10px;
  }
  .panel .labelrow{display:flex;justify-content:space-between;align-items:center;}
  .panel .labelrow .title{font-size:13px;color:var(--muted);font-weight:600}
  .row{display:flex;gap:10px;align-items:center;}
  input[type="color"]{width:44px;height:44px;padding:0;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
  .hex{font-family:monospace;padding:8px 10px;border-radius:8px;border:1px solid #e6eef9;width:100%;background:#fff;text-align:center;display:flex;align-items:center;gap:8px}
  .hex input{border:0;outline:0;width:100%;font-family:monospace}
  .small-btn{background:transparent;border:1px solid rgba(3,7,18,0.06);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .apply-inline{background:transparent;border:1px dashed rgba(11,116,209,0.16);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--accent);font-weight:600}

  /* Bottom-of-column apply complementary buttons */
  .col-bottom{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
  .apply-col{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(11,116,209,0.12);background:linear-gradient(180deg,#fff,#f6fbff);cursor:pointer;color:var(--accent);font-weight:600;text-align:center}

  /* Right preview */
  .right{width:44%; display:flex; flex-direction:column; align-items:center; gap:12px;}
  #preview-wrap{background:linear-gradient(180deg,#fff,#fbfeff);padding:18px;border-radius:14px;display:flex;flex-direction:column;align-items:center;box-shadow:0 6px 18px rgba(12,22,40,0.04);width:100%}
  #preview{width:100%;height:420px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#fff;border:1px solid rgba(3,7,18,0.03);overflow:auto;padding:12px}
  #preview svg{max-width:100%;height:auto;display:block}

  .downloads{display:flex;flex-direction:column;gap:8px;width:100%}
  .filename{padding:10px;border-radius:8px;border:1px solid #e6eef9;width:100%;font-family:inherit}
  .download-row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;flex:1}
  .btn.same{background:var(--accent)} /* uniform style marker */

  .muted{color:var(--muted);font-size:13px}

  /* copy icon button */
  .copy-btn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center}
  .copy-btn svg{width:18px;height:18px;opacity:0.85}

  /* undo button */
  .undo-btn{background:transparent;border:1px solid rgba(3,7,18,0.06);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--muted)}

  @media (max-width:980px){
    .card{flex-direction:column}
    .left{width:100%;grid-template-columns:1fr}
    .right{width:100%}
    #preview{height:320px}
  }
</style>
</head>
<body>
<div class="page">
  <div class="card" role="main" aria-label="TD Logo Customizer">
    <!-- LEFT: Controls -->
    <div class="left" aria-live="polite">
      <div style="grid-column:1 / -1">
        <h1>TD Logo Customizer</h1>
        <p class="desc">Edit fills, strokes and stroke widths. Type hex or use pickers — changes persist. Complementary colours are computed with an HSL hue shift (+180°). Use copy icons to copy hex values. Apply complementary fills or undo them (fills only).</p>
      </div>

      <!-- PATH column (left column of the grid) -->
      <div class="panel" id="panel-path">
        <div class="labelrow"><div class="title">Path — Fill</div><button class="small-btn" data-reset="pathFill" title="Reset Path Fill">↺</button></div>
        <div class="row" style="align-items:stretch">
          <input type="color" id="pathFillPicker" aria-label="Path fill color">
          <div class="hex" style="width:100%">
            <input id="pathFillHex" type="text" aria-label="Path fill hex" />
            <button class="copy-btn" data-copyfor="pathFillHex" title="Copy hex">
              <!-- custom copy icon (stacked squares) -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M8 7H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2"/><rect x="9" y="3" width="11" height="11" rx="2" stroke-width="1.6"/></svg>
            </button>
          </div>
        </div>

        <div class="labelrow"><div class="title">Path — Stroke</div><button class="small-btn" data-reset="pathStroke" title="Reset Path Stroke">↺</button></div>
        <div class="row" style="align-items:stretch">
          <input type="color" id="pathStrokePicker" aria-label="Path stroke color">
          <div class="hex" style="width:100%">
            <input id="pathStrokeHex" type="text" aria-label="Path stroke hex" />
            <button class="copy-btn" data-copyfor="pathStrokeHex" title="Copy hex">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M8 7H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2"/><rect x="9" y="3" width="11" height="11" rx="2" stroke-width="1.6"/></svg>
            </button>
          </div>
        </div>

        <div class="labelrow"><div class="title">Path — Stroke Width</div><button class="small-btn" data-reset="pathStrokeWidth" title="Reset Path Stroke Width">↺</button></div>
        <div class="row">
          <input id="pathStrokeWidth" type="number" min="0" step="0.5" style="padding:8px;border-radius:8px;border:1px solid #e6eef9;width:100%" />
        </div>

        <!-- small inline apply -->
        <div style="display:flex;gap:8px;align-items:center">
          <button id="applyPathToRect" class="apply-inline" title="Set Rectangle Fill to complement of Path Fill">Apply → Rect</button>
          <button id="undoPathFill" class="undo-btn" title="Undo last Path Fill change">Undo Fill</button>
        </div>

        <!-- bottom of path column: complementary apply -->
        <div class="col-bottom">
          <div style="font-size:13px;color:var(--muted)">Path complement (from rect)</div>
          <button id="applyPathComplementFromRect" class="apply-col">Apply complementary to Path</button>
        </div>
      </div>

      <!-- RECT column (right column of the grid) -->
      <div class="panel" id="panel-rect">
        <div class="labelrow"><div class="title">Rectangle — Fill</div><button class="small-btn" data-reset="rectFill" title="Reset Rectangle Fill">↺</button></div>
        <div class="row" style="align-items:stretch">
          <input type="color" id="rectFillPicker" aria-label="Rectangle fill color">
          <div class="hex" style="width:100%">
            <input id="rectFillHex" type="text" aria-label="Rectangle fill hex" />
            <button class="copy-btn" data-copyfor="rectFillHex" title="Copy hex">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M8 7H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2"/><rect x="9" y="3" width="11" height="11" rx="2" stroke-width="1.6"/></svg>
            </button>
          </div>
        </div>

        <div class="labelrow"><div class="title">Rectangle — Stroke</div><button class="small-btn" data-reset="rectStroke" title="Reset Rectangle Stroke">↺</button></div>
        <div class="row" style="align-items:stretch">
          <input type="color" id="rectStrokePicker" aria-label="Rectangle stroke color">
          <div class="hex" style="width:100%">
            <input id="rectStrokeHex" type="text" aria-label="Rectangle stroke hex" />
            <button class="copy-btn" data-copyfor="rectStrokeHex" title="Copy hex">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M8 7H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2"/><rect x="9" y="3" width="11" height="11" rx="2" stroke-width="1.6"/></svg>
            </button>
          </div>
        </div>

        <div class="labelrow"><div class="title">Rectangle — Stroke Width</div><button class="small-btn" data-reset="rectStrokeWidth" title="Reset Rectangle Stroke Width">↺</button></div>
        <div class="row">
          <input id="rectStrokeWidth" type="number" min="0" step="0.5" style="padding:8px;border-radius:8px;border:1px solid #e6eef9;width:100%" />
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="applyRectToPath" class="apply-inline" title="Set Path Fill to complement of Rect Fill">Apply → Path</button>
          <button id="undoRectFill" class="undo-btn" title="Undo last Rect Fill change">Undo Fill</button>
        </div>

        <div class="col-bottom">
          <div style="font-size:13px;color:var(--muted)">Rectangle complement (from path)</div>
          <button id="applyRectComplementFromPath" class="apply-col">Apply complementary to Rectangle</button>
        </div>
      </div>

      <!-- single-row panels to satisfy look: stroke width etc are individual panels already above -->

    </div>

    <!-- RIGHT: Preview + downloads -->
    <div class="right">
      <div id="preview-wrap" aria-live="polite">
        <div id="preview" title="Preview">
          <!-- SVG will be inlined here by JS (fetched from ./logo.svg) -->
          <div class="muted">Loading preview…</div>
        </div>

        <div class="downloads">
          <input id="fileName" class="filename" type="text" placeholder="filename (e.g. TD-custom)" title="File name for download">
          <div class="download-row">
            <button id="exportSVG" class="btn same" title="Download SVG">Download SVG</button>
            <button id="export1x" class="btn same" title="Download PNG at 1×">Download PNG 1×</button>
            <button id="export2x" class="btn same" title="Download PNG at 2×">Download PNG 2×</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
(() => {
  /* ---------- Defaults ---------- */
  const DEFAULTS = {
    pathFill: '#FFFFFF',
    pathStroke: '#000000',
    pathStrokeWidth: '2',
    rectFill: '#EEDC29',
    rectStroke: '#EEDC29',
    rectStrokeWidth: '0',
    fileName: 'TD-custom'
  };
  const STORAGE_KEY = 'tdLogoCustomizer_v1';
  const SVG_SOURCE = './logo.svg'; // file name you said you'll add

  /* ---------- Element refs ---------- */
  const refs = {
    // path
    pathFillPicker: document.getElementById('pathFillPicker'),
    pathFillHex: document.getElementById('pathFillHex'),
    pathStrokePicker: document.getElementById('pathStrokePicker'),
    pathStrokeHex: document.getElementById('pathStrokeHex'),
    pathStrokeWidth: document.getElementById('pathStrokeWidth'),
    applyPathToRect: document.getElementById('applyPathToRect'),
    applyPathComplementFromRect: document.getElementById('applyPathComplementFromRect'),
    undoPathFill: document.getElementById('undoPathFill'),
    // rect
    rectFillPicker: document.getElementById('rectFillPicker'),
    rectFillHex: document.getElementById('rectFillHex'),
    rectStrokePicker: document.getElementById('rectStrokePicker'),
    rectStrokeHex: document.getElementById('rectStrokeHex'),
    rectStrokeWidth: document.getElementById('rectStrokeWidth'),
    applyRectToPath: document.getElementById('applyRectToPath'),
    applyRectComplementFromPath: document.getElementById('applyRectComplementFromPath'),
    undoRectFill: document.getElementById('undoRectFill'),
    // copy buttons (delegated)
    copyButtons: document.querySelectorAll('.copy-btn'),
    // download
    export1xBtn: document.getElementById('export1x'),
    export2xBtn: document.getElementById('export2x'),
    exportSVGBtn: document.getElementById('exportSVG'),
    fileNameInput: document.getElementById('fileName'),
    // resets
    resetBtns: document.querySelectorAll('.small-btn[data-reset]'),
    // preview container
    preview: document.getElementById('preview')
  };

  let svgRoot = null;     // will hold the inlined <svg> element
  let pathEl = null;      // TD path element (found inside svg)
  let rectEl = null;      // background rectangle element
  // simple undo stacks (only fill changes)
  let undo = {
    pathFill: null,
    rectFill: null
  };

  /* ---------- Color helpers (HEX <-> RGB <-> HSL) ---------- */
  function normalizeHexInput(h){
    if(!h && h !== '') return null;
    h = String(h).trim();
    if(h === '') return '';
    if(!h.startsWith('#')) h = '#'+h;
    if(/^#([0-9a-fA-F]{3})$/i.test(h)) h = '#'+h[1]+h[1]+h[2]+h[2]+h[3]+h[3];
    if(/^#([0-9a-fA-F]{6})$/i.test(h)) return h.toUpperCase();
    return null;
  }
  function hexToRgb(hex){
    if(!hex) return null;
    let h = hex.replace('#','');
    if(h.length===3) h = h.split('').map(c=>c+c).join('');
    const bigint = parseInt(h,16);
    return { r: (bigint>>16)&255, g: (bigint>>8)&255, b: bigint&255 };
  }
  function rgbToHex(r,g,b){
    return '#' + [r,g,b].map(x=> ('0'+Math.round(Math.max(0,Math.min(255,x))).toString(16)).slice(-2)).join('').toUpperCase();
  }
  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h=0, s=0, l=(max+min)/2;
    if(max!==min){
      const d = max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h = (g-b)/d + (g<b?6:0); break;
        case g: h = (b-r)/d + 2; break;
        case b: h = (r-g)/d + 4; break;
      }
      h = h*60;
    }
    return {h: h, s: s, l: l};
  }
  function hslToRgb(h,s,l){
    h = ((h%360)+360)%360;
    if(s===0){
      const v = Math.round(l*255);
      return { r:v, g:v, b:v };
    }
    const c = (1 - Math.abs(2*l - 1)) * s;
    const x = c * (1 - Math.abs((h/60)%2 - 1));
    const m = l - c/2;
    let r1=0,g1=0,b1=0;
    if(h<60){ r1=c; g1=x; b1=0; }
    else if(h<120){ r1=x; g1=c; b1=0; }
    else if(h<180){ r1=0; g1=c; b1=x; }
    else if(h<240){ r1=0; g1=x; b1=c; }
    else if(h<300){ r1=x; g1=0; b1=c; }
    else { r1=c; g1=0; b1=x; }
    return { r: Math.round((r1+m)*255), g: Math.round((g1+m)*255), b: Math.round((b1+m)*255) };
  }
  function getComplementHex(hex){
    const rgb = hexToRgb(hex);
    if(!rgb) return '#000000';
    const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
    const newH = (hsl.h + 180) % 360;
    const rgb2 = hslToRgb(newH, hsl.s, hsl.l);
    return rgbToHex(rgb2.r, rgb2.g, rgb2.b);
  }

  /* ---------- Inline SVG load & find elements ---------- */
  async function loadAndInlineSVG(){
    try {
      const res = await fetch(SVG_SOURCE);
      if(!res.ok) throw new Error('Failed to fetch SVG: ' + res.status);
      const svgText = await res.text();
      // parse and insert
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, 'image/svg+xml');
      const svg = doc.querySelector('svg');
      if(!svg) throw new Error('No <svg> found in ' + SVG_SOURCE);
      // remove old preview children
      refs.preview.innerHTML = '';
      // adopt node into current document
      svg.setAttribute('id','svgRoot');
      svg.style.maxWidth = '100%';
      svg.style.height = 'auto';
      refs.preview.appendChild(svg);
      // set global refs
      svgRoot = svg;
      // find rect & path by common ids/labels — prefer friendly ids, fallbacks used
      rectEl = svgRoot.querySelector('#SquareBehindTD') || svgRoot.querySelector('rect');
      // path: try TDPath, path1, last path if needed
      pathEl = svgRoot.querySelector('#TDPath') || svgRoot.querySelector('#path1') || svgRoot.querySelector('path');
      // ensure default inline styles do not block our JS style property changes
      if(rectEl) rectEl.style.willChange = 'fill,stroke';
      if(pathEl) pathEl.style.willChange = 'fill,stroke,stroke-width';
      // apply initial UI values into SVG
      applyStyles();
    } catch (err) {
      refs.preview.innerHTML = '<div style="color:#b73;">Preview failed to load: ' + String(err.message) + '</div>';
      console.error(err);
    }
  }

  /* ---------- Apply to SVG ---------- */
  function applyStyles(){
    if(!pathEl || !rectEl) return;
    // path
    const pFill = refs.pathFillPicker.value;
    const pStroke = refs.pathStrokePicker.value;
    const pStrokeWidth = String(refs.pathStrokeWidth.value || DEFAULTS.pathStrokeWidth);
    pathEl.style.setProperty('fill', pFill);
    pathEl.style.setProperty('stroke', pStroke);
    pathEl.style.setProperty('stroke-width', pStrokeWidth);
    // rect
    const rFill = refs.rectFillPicker.value;
    const rStroke = refs.rectStrokePicker.value;
    const rStrokeWidth = String(refs.rectStrokeWidth.value || DEFAULTS.rectStrokeWidth);
    rectEl.style.setProperty('fill', rFill);
    rectEl.style.setProperty('stroke', rStroke);
    rectEl.style.setProperty('stroke-width', rStrokeWidth);
  }

  /* ---------- localStorage ---------- */
  function saveSettings(){
    const obj = {
      pathFill: normalizeHexInput(refs.pathFillPicker.value) || DEFAULTS.pathFill,
      pathStroke: normalizeHexInput(refs.pathStrokePicker.value) || DEFAULTS.pathStroke,
      pathStrokeWidth: String(refs.pathStrokeWidth.value),
      rectFill: normalizeHexInput(refs.rectFillPicker.value) || DEFAULTS.rectFill,
      rectStroke: normalizeHexInput(refs.rectStrokePicker.value) || DEFAULTS.rectStroke,
      rectStrokeWidth: String(refs.rectStrokeWidth.value),
      fileName: (refs.fileNameInput && refs.fileNameInput.value) ? refs.fileNameInput.value.trim() : DEFAULTS.fileName
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }
  function loadSettings(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const s = JSON.parse(raw);
        refs.pathFillPicker.value = s.pathFill || DEFAULTS.pathFill;
        refs.pathStrokePicker.value = s.pathStroke || DEFAULTS.pathStroke;
        refs.pathStrokeWidth.value = s.pathStrokeWidth != null ? s.pathStrokeWidth : DEFAULTS.pathStrokeWidth;
        refs.rectFillPicker.value = s.rectFill || DEFAULTS.rectFill;
        refs.rectStrokePicker.value = s.rectStroke || DEFAULTS.rectStroke;
        refs.rectStrokeWidth.value = s.rectStrokeWidth != null ? s.rectStrokeWidth : DEFAULTS.rectStrokeWidth;
        if(refs.fileNameInput) refs.fileNameInput.value = s.fileName || DEFAULTS.fileName;
        return;
      } catch(e){}
    }
    // fallback
    refs.pathFillPicker.value = DEFAULTS.pathFill;
    refs.pathStrokePicker.value = DEFAULTS.pathStroke;
    refs.pathStrokeWidth.value = DEFAULTS.pathStrokeWidth;
    refs.rectFillPicker.value = DEFAULTS.rectFill;
    refs.rectStrokePicker.value = DEFAULTS.rectStroke;
    refs.rectStrokeWidth.value = DEFAULTS.rectStrokeWidth;
    if(refs.fileNameInput) refs.fileNameInput.value = DEFAULTS.fileName;
  }

  /* ---------- UI sync & events ---------- */
  function refreshAllUI(){
    // ensure hex inputs match pickers (normalized)
    refs.pathFillHex.value = normalizeHexInput(refs.pathFillPicker.value) || refs.pathFillPicker.value;
    refs.pathStrokeHex.value = normalizeHexInput(refs.pathStrokePicker.value) || refs.pathStrokePicker.value;
    refs.rectFillHex.value = normalizeHexInput(refs.rectFillPicker.value) || refs.rectFillPicker.value;
    refs.rectStrokeHex.value = normalizeHexInput(refs.rectStrokePicker.value) || refs.rectStrokePicker.value;
    // complementary swatches handled by compute when pressing apply buttons
    applyStyles();
  }

  function wireInputs(){
    // color pickers -> hex text
    const pairs = [
      [refs.pathFillPicker, refs.pathFillHex],
      [refs.pathStrokePicker, refs.pathStrokeHex],
      [refs.rectFillPicker, refs.rectFillHex],
      [refs.rectStrokePicker, refs.rectStrokeHex]
    ];
    pairs.forEach(([picker, hexInput])=>{
      // picker change
      picker.addEventListener('input', () => {
        const nh = normalizeHexInput(picker.value) || picker.value;
        hexInput.value = nh;
        // if fill changed, push undo state for fill
        if(picker === refs.pathFillPicker){
          undo.pathFill = hexInput.value; // store last set before possible apply? we'll manage in apply actions
        }
        if(picker === refs.rectFillPicker){
          undo.rectFill = hexInput.value;
        }
        refreshAllUI(); saveSettings();
      });
      // hex typing
      hexInput.addEventListener('input', () => {
        const candidate = hexInput.value.trim();
        const nh = normalizeHexInput(candidate);
        // accept 3/6-digit or with/without #
        if(nh){
          picker.value = nh;
          hexInput.value = nh;
          refreshAllUI(); saveSettings();
        } else {
          // allow partial typing: don't update picker until valid
        }
      });
    });

    // stroke widths
    refs.pathStrokeWidth.addEventListener('input', () => { applyStyles(); saveSettings(); });
    refs.rectStrokeWidth.addEventListener('input', () => { applyStyles(); saveSettings(); });

    // reset buttons
    document.querySelectorAll('.small-btn[data-reset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-reset');
        switch(key){
          case 'pathFill':
            refs.pathFillPicker.value = DEFAULTS.pathFill; refs.pathFillHex.value = DEFAULTS.pathFill; break;
          case 'pathStroke':
            refs.pathStrokePicker.value = DEFAULTS.pathStroke; refs.pathStrokeHex.value = DEFAULTS.pathStroke; break;
          case 'pathStrokeWidth':
            refs.pathStrokeWidth.value = DEFAULTS.pathStrokeWidth; break;
          case 'rectFill':
            refs.rectFillPicker.value = DEFAULTS.rectFill; refs.rectFillHex.value = DEFAULTS.rectFill; break;
          case 'rectStroke':
            refs.rectStrokePicker.value = DEFAULTS.rectStroke; refs.rectStrokeHex.value = DEFAULTS.rectStroke; break;
          case 'rectStrokeWidth':
            refs.rectStrokeWidth.value = DEFAULTS.rectStrokeWidth; break;
        }
        refreshAllUI(); saveSettings();
      });
    });

    // copy buttons
    refs.copyButtons.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const targetId = btn.getAttribute('data-copyfor');
        const el = document.getElementById(targetId);
        if(!el) return;
        const val = el.value || '';
        navigator.clipboard.writeText(val).then(()=> {
          // quick visual feedback
          btn.style.transform = 'translateY(-2px)';
          setTimeout(()=> btn.style.transform = '', 160);
        }).catch(()=> alert('Copy failed'));
      });
    });

    /* ---------- Complementary apply actions ---------- */
    // Apply complement of Path -> Rect (quick inline)
    refs.applyPathToRect.addEventListener('click', ()=>{
      const source = normalizeHexInput(refs.pathFillPicker.value) || refs.pathFillPicker.value;
      if(!source) return;
      // push undo for rect (store current rect fill)
      undo.rectFill = refs.rectFillPicker.value;
      const comp = getComplementHex(source);
      refs.rectFillPicker.value = comp;
      refs.rectFillHex.value = comp;
      applyStyles(); saveSettings(); refreshAllUI();
    });
    // Apply complement of Rect -> Path (quick inline)
    refs.applyRectToPath.addEventListener('click', ()=>{
      const source = normalizeHexInput(refs.rectFillPicker.value) || refs.rectFillPicker.value;
      if(!source) return;
      undo.pathFill = refs.pathFillPicker.value;
      const comp = getComplementHex(source);
      refs.pathFillPicker.value = comp;
      refs.pathFillHex.value = comp;
      applyStyles(); saveSettings(); refreshAllUI();
    });

    // Bottom-of-column apply: Path complement from rect
    refs.applyPathComplementFromRect.addEventListener('click', ()=>{
      const rectFill = normalizeHexInput(refs.rectFillPicker.value) || refs.rectFillPicker.value;
      if(!rectFill) return;
      undo.pathFill = refs.pathFillPicker.value;
      const comp = getComplementHex(rectFill);
      refs.pathFillPicker.value = comp;
      refs.pathFillHex.value = comp;
      applyStyles(); saveSettings(); refreshAllUI();
    });
    // apply rectangle complement from path
    refs.applyRectComplementFromPath.addEventListener('click', ()=>{
      const pathFill = normalizeHexInput(refs.pathFillPicker.value) || refs.pathFillPicker.value;
      if(!pathFill) return;
      undo.rectFill = refs.rectFillPicker.value;
      const comp = getComplementHex(pathFill);
      refs.rectFillPicker.value = comp;
      refs.rectFillHex.value = comp;
      applyStyles(); saveSettings(); refreshAllUI();
    });

    // Undo fill actions (one-step)
    refs.undoPathFill.addEventListener('click', ()=>{
      if(undo.pathFill != null){
        refs.pathFillPicker.value = undo.pathFill;
        refs.pathFillHex.value = undo.pathFill;
        undo.pathFill = null;
        applyStyles(); saveSettings(); refreshAllUI();
      } else {
        // nothing to undo
      }
    });
    refs.undoRectFill.addEventListener('click', ()=>{
      if(undo.rectFill != null){
        refs.rectFillPicker.value = undo.rectFill;
        refs.rectFillHex.value = undo.rectFill;
        undo.rectFill = null;
        applyStyles(); saveSettings(); refreshAllUI();
      }
    });

    // download handlers
    refs.exportSVGBtn.addEventListener('click', () => exportSVG());
    refs.export1xBtn.addEventListener('click', () => exportPNG(1));
    refs.export2xBtn.addEventListener('click', () => exportPNG(2));
  }

  /* ---------- Exporting ---------- */
  function makeSerializableClone(scale=1){
    // clone root svg
    if(!svgRoot) return null;
    const clone = svgRoot.cloneNode(true);
    clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
    // ensure width/height use viewBox or attributes
    const vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
    const w = vb && vb.width ? vb.width : (parseInt(svgRoot.getAttribute('width')) || 1024);
    const h = vb && vb.height ? vb.height : (parseInt(svgRoot.getAttribute('height')) || 1024);
    clone.setAttribute('width', String(w * scale));
    clone.setAttribute('height', String(h * scale));
    // copy style.cssText into style attribute for each element so serializer keeps them
    clone.querySelectorAll('*').forEach(el => {
      if(el.style && el.style.cssText) el.setAttribute('style', el.style.cssText);
    });
    return { clone, w: (vb? vb.width : w), h: (vb? vb.height : h) };
  }

  function exportSVG(){
    if(!svgRoot) { alert('SVG not loaded'); return; }
    // apply styles before exporting
    applyStyles();
    const serializer = new XMLSerializer();
    // clone to preserve inline styles
    const { clone } = makeSerializableClone(1) || {};
    if(!clone) return;
    let svgString = serializer.serializeToString(clone);
    svgString = '<?xml version="1.0" encoding="utf-8"?>\n' + svgString;
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const rawName = (refs.fileNameInput && refs.fileNameInput.value.trim()) || DEFAULTS.fileName;
    const safeName = rawName.replace(/[^a-zA-Z0-9-_\.]/g,'_') || DEFAULTS.fileName;
    const a = document.createElement('a');
    a.href = url;
    a.download = `${safeName}.svg`;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
    saveSettings();
  }

  function exportPNG(scaleMultiplier=1){
    if(!svgRoot) { alert('SVG not loaded'); return; }
    applyStyles();
    const rawName = (refs.fileNameInput && refs.fileNameInput.value.trim()) || DEFAULTS.fileName;
    const safeName = rawName.replace(/[^a-zA-Z0-9-_\.]/g,'_') || DEFAULTS.fileName;
    const { clone, w, h } = makeSerializableClone(scaleMultiplier);
    if(!clone) return;
    const serializer = new XMLSerializer();
    let svgString = serializer.serializeToString(clone);
    svgString = '<?xml version="1.0" encoding="utf-8"?>\n' + svgString;
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(w * scaleMultiplier);
      canvas.height = Math.round(h * scaleMultiplier);
      const ctx = canvas.getContext('2d');
      // draw on white background to avoid transparent PNG (optional)
      // ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      const a = document.createElement('a');
      a.download = `${safeName}${scaleMultiplier>1?('@'+scaleMultiplier+'x') : ''}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
    img.onerror = () => { URL.revokeObjectURL(url); alert('Failed to render PNG. Try a modern browser.'); };
    img.src = url;
    saveSettings();
  }

  /* ---------- Init ---------- */
  async function init(){
    loadSettings();
    // initial hex fields
    refs.pathFillHex.value = normalizeHexInput(refs.pathFillPicker.value);
    refs.pathStrokeHex.value = normalizeHexInput(refs.pathStrokePicker.value);
    refs.rectFillHex.value = normalizeHexInput(refs.rectFillPicker.value);
    refs.rectStrokeHex.value = normalizeHexInput(refs.rectStrokePicker.value);
    // inline SVG
    await loadAndInlineSVG();
    // wire events
    wireInputs();
    // live UI updates whenever pickers change
    refreshAllUI();
    // ensure complementary buttons reflect current values (they compute on click)
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
