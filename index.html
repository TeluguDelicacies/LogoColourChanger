<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TD Logo Customizer — Complementary Fix (Complete)</title>
<style>
  :root{ --bg:#f4f6f8; --card:#fff; --muted:#6b7280; --accent:#0b74d1; --radius:12px; }
  html,body { height:100%; margin:0; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:#111; }
  .page { min-height:100%; display:flex; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .card {
    width:min(1100px,96%);
    background:var(--card);
    border-radius:var(--radius);
    padding:20px;
    box-shadow:0 8px 30px rgba(16,24,40,0.08);
    display:flex;
    gap:24px;
    align-items:flex-start;
    justify-content:space-between;
  }

  .left { width:520px; display:flex; flex-direction:column; gap:14px; }
  h1 { margin:0 0 4px 0; font-size:22px; }
  .desc { margin:0 0 12px 0; color:var(--muted); font-size:13px; }
  .controls { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }

  .control {
    background:#FBFCFD;
    border-radius:10px;
    padding:12px;
    border:1px solid rgba(15,23,42,0.03);
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:88px;
  }
  .control .label { font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .row { display:flex; gap:10px; align-items:center; }
  input[type="color"] { width:42px; height:42px; padding:0; border-radius:8px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; flex: 0 0 auto; }
  .hex { font-family:monospace; padding:8px 10px; border-radius:8px; border:1px solid #e6eef9; width:100%; background:#fff; text-align:center; box-sizing:border-box; }
  input[type="number"] { padding:8px 10px; border-radius:8px; border:1px solid #e6eef9; width:100%; text-align:center; }
  .small-btn { background:transparent; border:1px solid rgba(3,7,18,0.06); padding:6px 8px; border-radius:8px; cursor:pointer; color:var(--muted); }

  .apply-btn {
    display:block;
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px dashed rgba(11,116,209,0.16);
    cursor:pointer;
    color:var(--accent);
    font-weight:700;
    text-align:center;
    margin-top:6px;
    box-sizing:border-box;
  }

  .right { width:420px; display:flex; flex-direction:column; align-items:center; gap:12px; }
  #preview-wrap { background:linear-gradient(180deg,#fff,#fbfeff); padding:18px; border-radius:14px; display:flex; flex-direction:column; align-items:center; box-shadow:0 6px 18px rgba(12,22,40,0.04); }
  #preview { width:360px; height:360px; display:flex; align-items:center; justify-content:center; }
  #preview svg { max-width:100%; height:auto; display:block; }
  .actions { display:flex; gap:10px; margin-top:6px; align-items:center; flex-wrap:wrap; }

  .btn { background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
  .btn.secondary { background:#fff; color:var(--accent); border:1px solid rgba(11,116,209,0.14); }

  .filename-row { width:100%; display:flex; justify-content:flex-start; gap:10px; margin-top:8px; }
  .filename { padding:8px; border-radius:8px; border:1px solid #e6eef9; width:100%; box-sizing:border-box; }

  @media (max-width:980px){
    .card { flex-direction:column; align-items:center; }
    .left, .right { width:100%; }
    .controls { grid-template-columns:1fr; }
    .actions { flex-wrap:wrap; }
  }
</style>
</head>
<body>
<div class="page">
  <div class="card" role="main" aria-label="TD Logo Customizer">
    <div class="left">
      <h1>TD Logo Customizer</h1>
      <p class="desc">Edit fills, strokes and stroke widths. Use the "Apply" buttons under each fill hex to set complementary colours: Path → Rectangle and Rectangle → Path. Changes persist on refresh.</p>

      <div class="controls" role="group" aria-label="controls">

        <!-- Path Fill -->
        <div class="control" id="ctl-path-fill">
          <div class="label">
            <span>Path Fill</span>
            <div style="display:flex;gap:6px;align-items:center">
              <button class="small-btn" data-reset="pathFill" title="Reset Path Fill">↺</button>
            </div>
          </div>

          <div class="row" style="align-items:center;">
            <input type="color" id="pathFillPicker" aria-label="Path fill color">
            <input id="pathFillHex" class="hex" type="text" aria-label="Path fill hex">
          </div>

          <!-- Apply complement (below hex, full width) -->
          <button id="applyPathToRect" class="apply-btn" title="Set Rectangle Fill to complement of Path Fill">Apply complement → Rectangle</button>
        </div>

        <!-- Path Stroke -->
        <div class="control" id="ctl-path-stroke">
          <div class="label"><span>Path Stroke</span>
            <button class="small-btn" data-reset="pathStroke" title="Reset Path Stroke">↺</button>
          </div>
          <div class="row">
            <input type="color" id="pathStrokePicker" aria-label="Path stroke color">
            <input id="pathStrokeHex" class="hex" type="text" aria-label="Path stroke hex">
          </div>
        </div>

        <!-- Path Stroke Width -->
        <div class="control" id="ctl-path-width">
          <div class="label"><span>Path Stroke Width</span>
            <button class="small-btn" data-reset="pathStrokeWidth" title="Reset Path Stroke Width">↺</button>
          </div>
          <div class="row">
            <input id="pathStrokeWidth" type="number" min="0" step="0.5" />
          </div>
        </div>

        <!-- Rectangle Fill -->
        <div class="control" id="ctl-rect-fill">
          <div class="label"><span>Rectangle Fill</span>
            <button class="small-btn" data-reset="rectFill" title="Reset Rectangle Fill">↺</button>
          </div>

          <div class="row" style="align-items:center;">
            <input type="color" id="rectFillPicker" aria-label="Rectangle fill color">
            <input id="rectFillHex" class="hex" type="text" aria-label="Rectangle fill hex">
          </div>

          <!-- Apply complement (below hex, full width) -->
          <button id="applyRectToPath" class="apply-btn" title="Set Path Fill to complement of Rectangle Fill">Apply complement → Path</button>
        </div>

        <!-- Rectangle Stroke -->
        <div class="control" id="ctl-rect-stroke">
          <div class="label"><span>Rectangle Stroke</span>
            <button class="small-btn" data-reset="rectStroke" title="Reset Rectangle Stroke">↺</button>
          </div>
          <div class="row">
            <input type="color" id="rectStrokePicker" aria-label="Rectangle stroke color">
            <input id="rectStrokeHex" class="hex" type="text" aria-label="Rectangle stroke hex">
          </div>
        </div>

        <!-- Rectangle Stroke Width -->
        <div class="control" id="ctl-rect-width">
          <div class="label"><span>Rectangle Stroke Width</span>
            <button class="small-btn" data-reset="rectStrokeWidth" title="Reset Rectangle Stroke Width">↺</button>
          </div>
          <div class="row">
            <input id="rectStrokeWidth" type="number" min="0" step="0.5" />
          </div>
        </div>

      </div> <!-- controls -->

      <div style="display:flex; gap:10px; margin-top:6px; align-items:center;">
        <button id="resetAllBtn" class="btn secondary">Reset All</button>
      </div>

    </div> <!-- left -->

    <div class="right">
      <div id="preview-wrap" aria-live="polite">
        <div id="preview" title="Preview">
          <!-- INLINE SVG (original content, friendly IDs applied) -->
          <?xml version="1.0" encoding="UTF-8" standalone="no"?>
          <!-- Created with Inkscape (http://www.inkscape.org/) -->
          <svg id="svgRoot"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
             xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
             xmlns:svg="http://www.w3.org/2000/svg"
             width="1024" height="1024"
             viewBox="0 0 1024 1024"
             role="img" aria-label="TD logo preview">
            <defs id="defs1">
              <inkscape:path-effect effect="spiro" id="path-effect3" is_visible="true" lpeversion="1" />
              <inkscape:path-effect effect="spiro" id="path-effect2" is_visible="true" lpeversion="1" />
            </defs>
            <sodipodi:namedview id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25"
               inkscape:showpageshadow="2" inkscape:pageopacity="0.0" inkscape:pagecheckerboard="0"
               inkscape:deskcolor="#d1d1d1" inkscape:zoom="0.81347656" inkscape:cx="400.13445" inkscape:cy="325.14766"
               inkscape:window-width="1920" inkscape:window-height="1051" inkscape:window-x="-9" inkscape:window-y="-9"
               inkscape:window-maximized="1" inkscape:current-layer="g1" />
            <g inkscape:groupmode="layer" inkscape:label="Image" id="g1">
              <rect
                 id="SquareBehindTD"
                 style="fill:#eedc29;fill-opacity:1;stroke-width:1.6;fill-rule:nonzero"
                 width="800" height="800" x="113.09484" y="116.78271"
                 inkscape:label="Square Behind TD" />
              <path
                 id="TDPath"
                 style="fill:#ffffff;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-width:2;stroke-dasharray:none;stroke-dashoffset:0"
                 inkscape:label="TD Path"
                 d="m 419.65674,940.20232 c -6.62019,-2.11841 -12.35359,-8.61353 -13.81427,-15.64959 -1.97307,-9.50419 1.31056,-43.95566 6.99035,-73.34206 16.12051,-83.40515 51.53045,-192.53008 91.18284,-281.00359 9.43351,-21.04831 28.66618,-59.27576 37.73336,-75 18.27819,-31.69791 38.90638,-57.369 50.22838,-62.50754 11.07657,-5.02715 27.61651,0.65766 34.53819,11.87082 4.21446,6.82746 3.36234,9.6221 -6.80588,22.32079 -22.70035,28.34959 -50.90181,74.56806 -73.10896,119.81593 -24.88742,50.70901 -39.08543,85.89396 -59.11639,146.5 -11.51081,34.8273 -17.16552,54.2999 -22.68929,78.13299 -4.37888,18.89333 -16.1346,76.5901 -15.69483,77.02987 0.39446,0.39447 47.64256,-26.83694 69.67047,-40.15452 85.97817,-51.9805 158.80761,-110.63677 220.39982,-177.50834 29.94237,-32.50887 50.61951,-58.56139 71.82727,-90.5 36.18825,-54.49903 57.58561,-104.60108 66.41025,-155.5 2.57499,-14.85209 2.60049,-50.72883 0.045,-63.374 -2.63833,-13.05531 -6.21213,-23.57195 -9.91201,-29.16819 -5.09311,-7.70353 -17.58317,-19.57952 -24.38806,-23.18901 -7.91334,-4.19743 -27.14723,-9.71435 -45.38231,-13.01715 -13.31869,-2.41233 -16.78115,-2.6314 -42.5,-2.68897 -30.2576,-0.0677 -38.12952,0.67199 -69.90004,6.56851 -65.07557,12.07784 -112.51325,27.60471 -176.39207,57.73504 -36.00208,16.98144 -84.75861,44.79973 -121.22298,69.16438 l -11.51508,7.69412 -2.28742,23.88763 c -3.59292,37.52095 -4.11234,45.49943 -5.22476,80.25334 -2.06154,64.40626 0.7629,122.8963 9.15129,189.50973 3.52703,28.00867 3.3967,29.84537 -2.58794,36.46964 -4.90005,5.42378 -11.69156,8.50705 -19.789,8.98401 -10.39632,0.61236 -17.60288,-3.02228 -20.93701,-10.55964 -3.21089,-7.25874 -7.25073,-47.4206 -9.98542,-99.26944 -2.18543,-41.43506 -1.05795,-163.61877 1.82576,-197.85658 l 0.61962,-7.35658 -2.78098,1.82217 c -3.25453,2.13246 -11.74897,2.35796 -15.52594,0.41216 -11.53072,-5.94032 -13.89616,-18.66803 -5.02188,-27.02117 3.7842,-3.56197 18.70987,-12.83055 22.08158,-13.71227 1.47328,-0.38527 1.96154,-1.74861 2.37672,-6.63631 4.23367,-49.84118 9.19295,-82.4562 20.09897,-132.18233 3.5911,-16.37368 13.43906,-56.85728 16.10832,-66.21909 0.3883,-1.36186 0.20582,-2.25 -0.46229,-2.25 -2.88939,0 -89.83643,24.92447 -158.62945,45.47315 -64.69264,19.32388 -82.51558,24.43018 -87.79773,25.15418 -13.79249,1.89047 -28.312848,-11.97064 -24.804998,-23.67881 1.524129,-5.08707 5.061649,-10.02041 8.715448,-12.15435 6.87817,-4.01704 101.83508,-32.45079 175.88732,-52.66741 111.70466,-30.49592 228.23381,-59.47148 289.86473,-72.07633 85.99528,-17.58787 132.81865,-22.82455 193.63527,-21.65595 45.58866,0.876 68.50192,2.64756 74.82232,5.78498 13.24192,6.57322 11.94224,23.3204 -2.32232,29.92468 -3.6433,1.68679 -7.04434,1.85389 -38.13907,1.8739 -18.77649,0.0121 -42.17649,0.47764 -52,1.03458 -83.19633,4.71682 -173.96105,19.58285 -294.73343,48.27336 l -17.8725,4.24577 -1.79191,5.98412 c -22.51257,75.18142 -27.31339,92.40962 -33.39139,119.82801 -5.67642,25.60685 -7.87844,36.82658 -10.53072,53.65612 -1.17015,7.425 -2.29094,14.2875 -2.49065,15.25 -0.1997,0.9625 -0.2429,1.75 -0.096,1.75 0.1469,0 4.94227,-3.06272 10.65638,-6.80604 53.00801,-34.72566 117.1805,-68.20712 172.88929,-90.20354 31.39645,-12.39678 76.9532,-25.80927 112,-32.97424 36.74082,-7.51129 91.56038,-10.07301 120,-5.6076 13.93029,2.18725 37.36553,8.3209 45.45469,11.89675 27.22265,12.03391 48.77301,30.46718 66.28182,56.69467 9.99945,14.97877 16.89318,31.97689 21.2918,52.5 2.71345,12.66042 3.84683,49.32613 2.06148,66.69064 -4.51344,43.89842 -18.93917,83.44636 -46.33623,127.0301 -45.68425,72.67535 -117.23185,148.78668 -206.75356,219.94151 -64.4352,51.21524 -153.41761,109.46575 -217,142.05458 -19.70369,10.09903 -33.4404,13.37388 -43.11397,10.27841 z"/>
            </g>
          </svg>
        </div>

        <div class="filename-row">
          <input id="fileName" class="filename" type="text" placeholder="filename (e.g. TD-custom)" title="File name for download">
        </div>

        <div class="actions">
          <button id="export1x" class="btn secondary" title="Download PNG at 1×">Download PNG</button>
          <button id="export2x" class="btn" title="Download PNG at 2×">
              Download PNG<br><span style="font-size: 0.8em; opacity: 0.8;">(Higher Resolution)</span>
          </button>
        </div>
      </div>
    </div> <!-- right -->

  </div> <!-- card -->
</div> <!-- page -->

<script>
(() => {
  /* ---------- Defaults ---------- */
  const DEFAULTS = {
    pathFill: '#FFFFFF',
    pathStroke: '#000000',
    pathStrokeWidth: '2',
    rectFill: '#EEDC29',
    rectStroke: '#EEDC29',
    rectStrokeWidth: '0',
    fileName: 'TD-custom'
  };
  const STORAGE_KEY = 'tdLogoSettings_v4';

  /* ---------- Elements ---------- */
  const svgRoot = document.getElementById('svgRoot');
  const pathEl = document.getElementById('TDPath');
  const rectEl = document.getElementById('SquareBehindTD');

  const controls = {
    pathFillPicker: document.getElementById('pathFillPicker'),
    pathFillHex:    document.getElementById('pathFillHex'),
    pathStrokePicker: document.getElementById('pathStrokePicker'),
    pathStrokeHex:    document.getElementById('pathStrokeHex'),
    pathStrokeWidth:  document.getElementById('pathStrokeWidth'),

    rectFillPicker: document.getElementById('rectFillPicker'),
    rectFillHex:    document.getElementById('rectFillHex'),
    rectStrokePicker: document.getElementById('rectStrokePicker'),
    rectStrokeHex:    document.getElementById('rectStrokeHex'),
    rectStrokeWidth: document.getElementById('rectStrokeWidth'),

    resetAllBtn: document.getElementById('resetAllBtn'),

    applyPathToRectBtn: document.getElementById('applyPathToRect'),
    applyRectToPathBtn: document.getElementById('applyRectToPath'),

    export1xBtn: document.getElementById('export1x'),
    export2xBtn: document.getElementById('export2x'),
    fileNameInput: document.getElementById('fileName')
  };

  /* ---------- Color helpers (HEX <-> RGB <-> HSL) ---------- */
  function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }
  function normalizeHexInput(h){
    if(!h) return null;
    h = String(h).trim();
    if(!h) return null;
    if(!h.startsWith('#')) h = '#'+h;
    if(/^#([0-9a-fA-F]{3})$/i.test(h)) h = '#'+h[1]+h[1]+h[2]+h[2]+h[3]+h[3];
    if(/^#([0-9a-fA-F]{6})$/i.test(h)) return h.toUpperCase();
    return null;
  }
  function hexToRgb(hex){
    if(!hex) return null;
    let h = hex.replace('#','');
    if(h.length===3) h = h.split('').map(c=>c+c).join('');
    const bigint = parseInt(h,16);
    return { r: (bigint>>16)&255, g: (bigint>>8)&255, b: bigint&255 };
  }
  function rgbToHex(r,g,b){
    return '#' + [r,g,b].map(x=> ('0'+Math.round(clamp(x,0,255)).toString(16)).slice(-2)).join('').toUpperCase();
  }
  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h=0, s=0, l=(max+min)/2;
    if(max!==min){
      const d = max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h = (g-b)/d + (g<b?6:0); break;
        case g: h = (b-r)/d + 2; break;
        case b: h = (r-g)/d + 4; break;
      }
      h = h*60;
    }
    return {h: h, s: s, l: l};
  }
  function hslToRgb(h,s,l){
    h = ((h%360)+360)%360;
    if(s===0){
      const v = Math.round(l*255);
      return { r:v, g:v, b:v };
    }
    const c = (1 - Math.abs(2*l - 1)) * s;
    const x = c * (1 - Math.abs((h/60)%2 - 1));
    const m = l - c/2;
    let r1=0,g1=0,b1=0;
    if(h<60){ r1=c; g1=x; b1=0; }
    else if(h<120){ r1=x; g1=c; b1=0; }
    else if(h<180){ r1=0; g1=c; b1=x; }
    else if(h<240){ r1=0; g1=x; b1=c; }
    else if(h<300){ r1=x; g1=0; b1=c; }
    else { r1=c; g1=0; b1=x; }
    return { r: Math.round((r1+m)*255), g: Math.round((g1+m)*255), b: Math.round((b1+m)*255) };
  }
  function getComplementHex(hex){
    const rgb = hexToRgb(hex);
    if(!rgb) return '#000000';
    const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
    const newH = (hsl.h + 180) % 360;
    const rgb2 = hslToRgb(newH, hsl.s, hsl.l);
    return rgbToHex(rgb2.r, rgb2.g, rgb2.b);
  }
  function getContrastColor(hex){
    const c = hexToRgb(hex);
    if(!c) return '#000000';
    // perceptual luminance
    const lum = (0.299*c.r + 0.587*c.g + 0.114*c.b)/255;
    return lum > 0.65 ? '#000000' : '#FFFFFF';
  }

  /* ---------- Apply styles to SVG ---------- */
  function applyStyles(){
    if(!pathEl || !rectEl) return;
    const pFill = controls.pathFillPicker.value;
    const pStroke = controls.pathStrokePicker.value;
    const pStrokeWidth = String(controls.pathStrokeWidth.value || DEFAULTS.pathStrokeWidth);

    // set inline style (so cloning for export will pick it up)
    pathEl.style.setProperty('fill', pFill);
    pathEl.style.setProperty('stroke', pStroke);
    pathEl.style.setProperty('stroke-width', pStrokeWidth);

    const rFill = controls.rectFillPicker.value;
    const rStroke = controls.rectStrokePicker.value;
    const rStrokeWidth = String(controls.rectStrokeWidth.value || DEFAULTS.rectStrokeWidth);

    rectEl.style.setProperty('fill', rFill);
    rectEl.style.setProperty('stroke', rStroke);
    rectEl.style.setProperty('stroke-width', rStrokeWidth);
  }

  /* ---------- localStorage ---------- */
  function saveSettings(){
    const obj = {
      pathFill: normalizeHexInput(controls.pathFillPicker.value) || DEFAULTS.pathFill,
      pathStroke: normalizeHexInput(controls.pathStrokePicker.value) || DEFAULTS.pathStroke,
      pathStrokeWidth: String(controls.pathStrokeWidth.value),
      rectFill: normalizeHexInput(controls.rectFillPicker.value) || DEFAULTS.rectFill,
      rectStroke: normalizeHexInput(controls.rectStrokePicker.value) || DEFAULTS.rectStroke,
      rectStrokeWidth: String(controls.rectStrokeWidth.value),
      fileName: (controls.fileNameInput && controls.fileNameInput.value) ? controls.fileNameInput.value.trim() : DEFAULTS.fileName
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }
  function loadSettings(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const s = JSON.parse(raw);
        controls.pathFillPicker.value = s.pathFill || DEFAULTS.pathFill;
        controls.pathStrokePicker.value = s.pathStroke || DEFAULTS.pathStroke;
        controls.pathStrokeWidth.value = s.pathStrokeWidth != null ? s.pathStrokeWidth : DEFAULTS.pathStrokeWidth;
        controls.rectFillPicker.value = s.rectFill || DEFAULTS.rectFill;
        controls.rectStrokePicker.value = s.rectStroke || DEFAULTS.rectStroke;
        controls.rectStrokeWidth.value = s.rectStrokeWidth != null ? s.rectStrokeWidth : DEFAULTS.rectStrokeWidth;
        if(controls.fileNameInput) controls.fileNameInput.value = s.fileName || DEFAULTS.fileName;
        return;
      }catch(e){}
    }
    controls.pathFillPicker.value = DEFAULTS.pathFill;
    controls.pathStrokePicker.value = DEFAULTS.pathStroke;
    controls.pathStrokeWidth.value = DEFAULTS.pathStrokeWidth;
    controls.rectFillPicker.value = DEFAULTS.rectFill;
    controls.rectStrokePicker.value = DEFAULTS.rectStroke;
    controls.rectStrokeWidth.value = DEFAULTS.rectStrokeWidth;
    if(controls.fileNameInput) controls.fileNameInput.value = DEFAULTS.fileName;
  }

  /* ---------- Update Apply buttons colors & labels ---------- */
  function updateApplyButtonsPreview(){
    // Path -> Rect: compute complement of path fill (this is the colour that will be applied to rectangle)
    const pathFill = normalizeHexInput(controls.pathFillPicker.value) || controls.pathFillPicker.value;
    const compForRect = getComplementHex(pathFill);
    controls.applyPathToRectBtn.style.background = compForRect;
    controls.applyPathToRectBtn.style.color = getContrastColor(compForRect);
    controls.applyPathToRectBtn.textContent = `Apply ${compForRect} → Rectangle`;

    // Rect -> Path
    const rectFill = normalizeHexInput(controls.rectFillPicker.value) || controls.rectFillPicker.value;
    const compForPath = getComplementHex(rectFill);
    controls.applyRectToPathBtn.style.background = compForPath;
    controls.applyRectToPathBtn.style.color = getContrastColor(compForPath);
    controls.applyRectToPathBtn.textContent = `Apply ${compForPath} → Path`;
  }

  /* ---------- Sync UI (hex boxes and apply button previews) ---------- */
  function refreshAllUI(){
    controls.pathFillHex.value = normalizeHexInput(controls.pathFillPicker.value) || controls.pathFillPicker.value;
    controls.pathStrokeHex.value = normalizeHexInput(controls.pathStrokePicker.value) || controls.pathStrokePicker.value;
    controls.rectFillHex.value = normalizeHexInput(controls.rectFillPicker.value) || controls.rectFillPicker.value;
    controls.rectStrokeHex.value = normalizeHexInput(controls.rectStrokePicker.value) || controls.rectStrokePicker.value;

    updateApplyButtonsPreview();
    applyStyles();
  }

  /* ---------- Wiring inputs & buttons ---------- */
  function wireInputs(){
    // color <-> hex synchronization for the four color controls
    const colorPairs = [
      [controls.pathFillPicker, controls.pathFillHex],
      [controls.pathStrokePicker, controls.pathStrokeHex],
      [controls.rectFillPicker, controls.rectFillHex],
      [controls.rectStrokePicker, controls.rectStrokeHex]
    ];
    colorPairs.forEach(([picker, hexInput])=>{
      picker.addEventListener('input', () => {
        const nh = normalizeHexInput(picker.value) || picker.value;
        hexInput.value = nh;
        refreshAllUI();
        saveSettings();
      });
      hexInput.addEventListener('input', () => {
        const nh = normalizeHexInput(hexInput.value);
        if(nh){
          picker.value = nh;
          hexInput.value = nh;
          refreshAllUI();
          saveSettings();
        }
      });
    });

    // stroke widths
    controls.pathStrokeWidth.addEventListener('input', () => { applyStyles(); saveSettings(); });
    controls.rectStrokeWidth.addEventListener('input', () => { applyStyles(); saveSettings(); });

    // per-control reset buttons
    document.querySelectorAll('.small-btn[data-reset]').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-reset');
        switch(key){
          case 'pathFill':
            controls.pathFillPicker.value = DEFAULTS.pathFill; controls.pathFillHex.value = DEFAULTS.pathFill; break;
          case 'pathStroke':
            controls.pathStrokePicker.value = DEFAULTS.pathStroke; controls.pathStrokeHex.value = DEFAULTS.pathStroke; break;
          case 'pathStrokeWidth':
            controls.pathStrokeWidth.value = DEFAULTS.pathStrokeWidth; break;
          case 'rectFill':
            controls.rectFillPicker.value = DEFAULTS.rectFill; controls.rectFillHex.value = DEFAULTS.rectFill; break;
          case 'rectStroke':
            controls.rectStrokePicker.value = DEFAULTS.rectStroke; controls.rectStrokeHex.value = DEFAULTS.rectStroke; break;
          case 'rectStrokeWidth':
            controls.rectStrokeWidth.value = DEFAULTS.rectStrokeWidth; break;
        }
        refreshAllUI(); saveSettings();
      });
    });

    // global reset
    controls.resetAllBtn.addEventListener('click', () => {
      controls.pathFillPicker.value = DEFAULTS.pathFill; controls.pathFillHex.value = DEFAULTS.pathFill;
      controls.pathStrokePicker.value = DEFAULTS.pathStroke; controls.pathStrokeHex.value = DEFAULTS.pathStroke;
      controls.pathStrokeWidth.value = DEFAULTS.pathStrokeWidth;
      controls.rectFillPicker.value = DEFAULTS.rectFill; controls.rectFillHex.value = DEFAULTS.rectFill;
      controls.rectStrokePicker.value = DEFAULTS.rectStroke; controls.rectStrokeHex.value = DEFAULTS.rectStroke;
      controls.rectStrokeWidth.value = DEFAULTS.rectStrokeWidth;
      controls.fileNameInput.value = DEFAULTS.fileName;
      refreshAllUI(); saveSettings();
    });

    // Apply complement buttons
    controls.applyPathToRectBtn.addEventListener('click', () => {
      const p = normalizeHexInput(controls.pathFillPicker.value) || controls.pathFillPicker.value;
      const comp = getComplementHex(p);
      controls.rectFillPicker.value = comp;
      controls.rectFillHex.value = comp;
      refreshAllUI(); saveSettings();
    });
    controls.applyRectToPathBtn.addEventListener('click', () => {
      const r = normalizeHexInput(controls.rectFillPicker.value) || controls.rectFillPicker.value;
      const comp = getComplementHex(r);
      controls.pathFillPicker.value = comp;
      controls.pathFillHex.value = comp;
      refreshAllUI(); saveSettings();
    });

    // export buttons wired in init
  }

  /* ---------- Export PNG (serialize inline styles) ---------- */
  function makeSerializableClone(scale=1){
    const clone = svgRoot.cloneNode(true);
    clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
    // get viewBox size
    const vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
    const w = vb && vb.width ? vb.width : (parseInt(svgRoot.getAttribute('width')) || 1024);
    const h = vb && vb.height ? vb.height : (parseInt(svgRoot.getAttribute('height')) || 1024);
    clone.setAttribute('width', String(w * scale));
    clone.setAttribute('height', String(h * scale));
    // copy inline style cssText into style attribute for each element
    clone.querySelectorAll('*').forEach(el => {
      if(el.style && el.style.cssText) el.setAttribute('style', el.style.cssText);
    });
    return { clone, w: (vb? vb.width : w), h: (vb? vb.height : h) };
  }

  function exportPNG(scaleMultiplier=1){
    applyStyles();
    // get filename
    const rawName = controls.fileNameInput && controls.fileNameInput.value.trim();
    const safeName = rawName ? rawName.replace(/[^a-zA-Z0-9-_\.]/g,'_') : DEFAULTS.fileName;
    saveSettings();

    const { clone, w, h } = makeSerializableClone(scaleMultiplier);
    const serializer = new XMLSerializer();
    let svgString = serializer.serializeToString(clone);
    svgString = '<?xml version="1.0" encoding="utf-8"?>\n' + svgString;
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(w * scaleMultiplier);
      canvas.height = Math.round(h * scaleMultiplier);
      const ctx = canvas.getContext('2d');
      // optional white background: uncomment if needed
      // ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      const a = document.createElement('a');
      a.download = `${safeName}${scaleMultiplier>1?('@'+scaleMultiplier+'x') : ''}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
    img.onerror = () => { URL.revokeObjectURL(url); alert('Failed to render SVG to PNG. Try a modern browser (Chrome/Firefox/Edge).'); };
    img.src = url;
  }

  /* ---------- Init ---------- */
  function init(){
    loadSettings();

    // init hex inputs to match pickers
    controls.pathFillHex.value = normalizeHexInput(controls.pathFillPicker.value);
    controls.pathStrokeHex.value = normalizeHexInput(controls.pathStrokePicker.value);
    controls.rectFillHex.value = normalizeHexInput(controls.rectFillPicker.value);
    controls.rectStrokeHex.value = normalizeHexInput(controls.rectStrokePicker.value);

    // file name default
    if(!controls.fileNameInput.value) controls.fileNameInput.value = DEFAULTS.fileName;

    refreshAllUI();
    wireInputs();

    controls.export1xBtn.addEventListener('click', () => exportPNG(1));
    controls.export2xBtn.addEventListener('click', () => exportPNG(2));
  }

  document.addEventListener('DOMContentLoaded', init);

})();
</script>
</body>
</html>
